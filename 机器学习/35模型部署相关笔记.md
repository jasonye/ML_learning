# 模型部署和运维

使用Docker进行部署，把模型文件信息等统一打包的Docker Images中。然后在Docker中运行对应的setup.py文件，执行模型文件。进一步，可以参考引入使用MLOps等通用业内工具。

参考这个文档：https://www.cgustavo.com/blog/ml-model-packaging-fundamentals， 一个模型从开发环境，到生产环境，或者共享环境，通常包含下面四个方面的组件：
 * Model artifacts：模型对象的序列化文件，通常用.pkl等格式化文件表示
 * 环境信息文件：比如通过requirements.txt、 setup.sh 包含环境相关信息，里面包含模型加载、启动的比较信息
 * Model interface：模型接口文件，通常通过a.py文件，定义模型执行所需要的load_model()\predict()两个文件
 * Metadata：包含模型相关的基础信息说明、版本、描述、Input_features、output_features（各字段说明）、模型超级参数等等。


1. Model artifacts制品
训练好的模型，为了能够部署、重用或者分享（减少重复训练模型的工作：包括数据清洗、数据准备、调试等等）。可以选择.pkl、.h5、.joblib、.onnx等格式保存下来，然后使用Docker打包到生产环境。最后通过Flask等重新模型数据。使得模型在生产环境可以起作用。

更多个格式的选择可以参考文档: https://medium.com/@rohanmistry231/beyond-pkl-the-complete-guide-to-saving-machine-learning-models-ddefaeb3e53e


.pkl (Pickled Python Objects): This format is specifically designed for the scikit-learn library in Python. It stores the model architecture and learned parameters in a way that scikit-learn understands for future use or sharing with others who use scikit-learn.

.pt (PyTorch Tensors): This format is optimized for the PyTorch framework. It stores the model architecture and learned parameters as tensors, a data structure that PyTorch heavily relies on for efficient machine learning computations.

.h5 (Hierarchical Data Format 5): This versatile format is like a universal toolbox. It can be used by various libraries and can store not just the model architecture and learned parameters, but also additional data used during training. This makes it a good choice for sharing models between different tools or archiving them for future reference.

### Final Thoughts
There is no one-size-fits-all format for storing machine learning models. Choose based on:

Framework: TensorFlow, PyTorch, Scikit-learn
Use case: Deployment, portability, collaboration
Complexity: Single file or full pipeline
Start with joblib or h5 for simplicity, and move to ONNX or MLflow for scalable production.

Your model deserves a good home — so pick the format that makes sharing, deploying, and maintaining it effortless.

### .pkl: 最经典的Pickl格式

.pkl广泛用于：Scikit-learn、XGBoost、LightGBM，Python使用built-in pickle来序列化对象，包括ML模型。

优缺点：
1. 广泛使用、Python内置
2. 缺陷是不跨语言、潜在不安全

```python
import pickle

# Save model
with open('model.pkl', 'wb') as f:
    pickle.dump(model, f)
# Load model
with open('model.pkl', 'rb') as f:
    model = pickle.load(f)


# 或者使用jobli

import joblib

joblib.dump(model, "model.joblib")
model = joblib.load("model.joblib")

```







打包镜像：

```shell
# Docker code
FROM python:3.8-slim
COPY model.pkl /app/model.pkl
COPY app.py /app/app.py# 待了解技术方案


WORKDIR /app
RUN pip install -r requirements.txt
CMD ["python", "app.py"]

```

模型上线后，可以继续验证模型的泛化能力、进行数据监控和运维。通过A/B Test评估模型的好坏。

```python
# Import necessary libraries
from sklearn.metrics import accuracy_score, precision_score, recall_score

# Load your test data 
test_df = pd.read_csv('your_test_data.csv')  

X_test = test_df.drop(columns=['target_column'])
y_test = test_df['target_column']

# Predict outcomes on the test set
y_pred_test = best_model.predict(X_test)

# Evaluate performance metrics
test_accuracy = accuracy_score(y_test, y_pred_test)
test_precision = precision_score(y_test, y_pred_test, average='weighted')
test_recall = recall_score(y_test, y_pred_test, average='weighted')

# Print performance metrics
print(f"Test Set Accuracy: {test_accuracy}")
print(f"Test Set Precision: {test_precision}")
print(f"Test Set Recall: {test_recall}")
```